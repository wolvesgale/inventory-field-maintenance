# 在庫・棚卸管理システム 操作説明書（土台テキスト）

> バージョン: v1.0（2026-02-28 初稿）
> 対象読者: 現場担当（worker）・管理者（manager / admin）

---

## はじめに

このシステムは、現場での入出庫登録から承認・在庫台帳管理・月末棚卸・月次報告書作成までを一貫して行うためのWebアプリケーションです。

データはすべて Google スプレッドシートに保存されます。アプリを介した操作のみが正式な操作手順です。スプレッドシートへの直接編集は行わないでください。

---

## アクセス方法

- **URL**: （管理者より通知）
- **対応ブラウザ**: Google Chrome 推奨（最新版）
- **推奨デバイス**: PC またはタブレット（スマートフォン非推奨）

---

## ログイン

1. ブラウザでシステムのURLにアクセスする
2. 「ログインID」と「パスワード」を入力する
3. 「ログイン」ボタンをクリックする

**ログインできない場合**:
- 大文字/小文字を確認する
- 管理者にID・パスワードの確認を依頼する

---

## 画面構成（ナビゲーション）

ログイン後、画面上部にナビゲーションバーが表示されます。

| メニュー | 説明 | 利用可能ロール |
|---|---|---|
| ダッシュボード | トップ画面 | 全員 |
| 入出庫登録 | 取引履歴・新規登録 | 全員 |
| 承認 | 申請の承認・差し戻し | manager / admin |
| 在庫台帳 | 品目別在庫数の確認 | manager / admin |
| 棚卸 | 月末棚卸の実施 | manager / admin |
| 月次レポート | 月次締め・報告書生成 | manager / admin |

---

## 【現場担当（worker）向け】基本操作

### 入出庫の登録

**入庫（IN）**: 物品が届いたとき / 返品されてきたとき
**出庫（OUT）**: 物品を使用・発送するとき

#### 登録手順

1. ナビゲーションの「入出庫登録」をクリック
2. 「新規登録」ボタンをクリック
3. 以下を入力する:
   - **品目**: 品目コードまたは品目名で検索して選択する
   - **種別**: 入庫(IN) / 出庫(OUT) を選択する
   - **数量**: 数量を入力する（マイナス入力不可）
   - **日付**: 取引日付を選択する（デフォルトは本日）
   - **備考**: 理由・コメントなど（任意）
4. 「申請する」ボタンをクリックする

> **注意**: 登録したデータはすぐに有効にはなりません。管理者による「承認」後に在庫数に反映されます。

#### 申請後のステータス確認

| ステータス | 意味 |
|---|---|
| draft（下書き） | 保存済み・未申請 |
| pending（申請中） | 管理者の確認待ち |
| approved（承認済） | 承認され在庫に反映済み |
| returned（差し戻し） | 内容に問題あり・修正が必要 |
| locked（締め済み） | 月次締め処理が完了 |

#### 差し戻しされた場合

1. 「入出庫登録」一覧から対象の取引をクリック
2. 差し戻しコメントを確認する
3. 内容を修正して「再申請する」をクリックする

---

## 【管理者（manager / admin）向け】基本操作

### 承認処理

現場担当が登録した入出庫申請を確認し、承認または差し戻しを行います。

#### 手順

1. ナビゲーションの「承認」をクリック
2. 申請一覧が表示される（ステータスが `pending` のもの）
3. 確認したい申請をクリックして詳細を表示する
4. 内容が正しければ「承認」ボタンをクリックする
   - 承認すると在庫台帳に即時反映される
5. 内容に問題があれば差し戻しコメントを入力して「差し戻し」をクリックする

> **注意**: 承認操作は取り消せません。誤承認した場合は管理者に連絡してください。

---

### 在庫台帳の確認

現在の在庫数（品目別）を確認できます。

1. ナビゲーションの「在庫台帳」をクリック
2. 品目グループでフィルタリングできる
3. 各品目の「期首数量・入庫数・出庫数・期末数量」が表示される

> **注意**: 表示されている数値は承認済み（approved / locked）の取引のみを集計したものです。

> **現在の制約**: 月次締め後も在庫台帳の「入庫数/出庫数」は**全期間の累計**が表示されます。月別の集計は月次レポート画面で確認してください。

---

### 棚卸の実施

月末に実際の在庫数をカウントし、システムの数値と照合します。

#### 手順

1. ナビゲーションの「棚卸」をクリック
2. 棚卸日付を選択する（月末日を推奨）
3. 品目一覧が表示される（システム上の在庫数が「予定数量」として表示）
4. 各品目を実際に数え、「実在庫数」欄に入力する
5. 差異（実在庫 − 予定数量）が自動計算される
6. 「保存」ボタンをクリックする

> 差異がある品目は差異ログ（DiffLog）に自動記録されます。

---

### 月次レポート・月次締め

月が終わるタイミングで、月次レポートを生成し締め処理を行います。

#### 月次レポート生成（確認）

1. ナビゲーションの「月次レポート」をクリック
2. 対象月（例：2026-02）を入力する
3. 「レポート生成」をクリック → 対象月の入出庫サマリーが表示される
4. 内容を確認する

#### 月次締め（finalize）

> **重要**: この操作は取り消せません。実行前に内容を必ず確認してください。

1. レポートを確認した後、「月次締め実行」ボタンをクリックする
2. 確認ダイアログが表示されるので「実行」をクリックする
3. 対象月のトランザクションが `locked` 状態になり、SupplierReports に記録される

#### 月次締め後の手動作業（現在の制約への対応）

月次締め後、以下を手動で実施してください:

1. Google スプレッドシートの `StockLedger` シートを開く
2. 各品目の `opening_qty` 列に、現在の `closing_qty` の値をコピーする
3. `in_qty`・`out_qty` 列を 0 にリセットする
4. `closing_qty` を `opening_qty` と同じ値に更新する

> この作業が完了することで、翌月の在庫台帳が正しい期首残高から始まります。

---

## ユーザー管理

### パスワードの変更

1. 「設定」または「パスワード変更」メニューへアクセス（管理者機能）
2. 対象ユーザーの login_id を入力する
3. 新しいパスワードを入力・確認入力する
4. 「変更する」をクリックする

---

## よくある質問（FAQ）

**Q. 承認した取引を取り消せますか？**
A. アプリ上からは取り消せません。誤承認の場合は逆の取引（入庫を誤承認した場合は出庫）を登録して数量を補正するか、管理者に連絡してください。

**Q. 品目が検索で見つからない場合は？**
A. 品目マスタ（Itemsシート）に登録されていない可能性があります。管理者に品目の追加を依頼してください。

**Q. 在庫数がマイナスになっています。なぜですか？**
A. 出庫数が期首残高を超えた場合に発生します。期首残高の設定ミスか、入庫登録の漏れが考えられます。管理者に確認してください。

**Q. 月次締めを2回実行してしまいました。**
A. SupplierReports シートに二重登録が発生している可能性があります。管理者がスプレッドシートで重複行を確認・削除してください。

**Q. 取引一覧の件数が途中で途切れているようです。**
A. 現在のシステムは1シートあたり最大1,000件まで表示されます。件数が上限に近づいている場合は管理者に報告してください。

---

## トラブルシューティング

| 症状 | 確認事項 |
|---|---|
| ログインできない | ID・パスワードの確認。Capsロックの確認。管理者へ連絡 |
| 操作後に「エラーが発生しました」 | ブラウザをリロードして再試行。改善しない場合は管理者へ |
| 在庫数が予想と違う | 未承認の申請がないか確認。管理者に台帳との突き合わせを依頼 |
| 棚卸画面が遅い | 品目数が多い場合は時間がかかる。ページ操作を重複させない |
| 月次レポートが空白 | 対象月に承認済みトランザクションが存在するか確認 |

---

## 運用上の注意事項

1. **スプレッドシートの直接編集禁止**: データの整合性を保つため、必ずアプリ経由で操作してください
2. **ブラウザの同時操作**: 同一ユーザーが複数タブで操作することは避けてください
3. **定期バックアップ**: Google スプレッドシートの「変更履歴」を活用してください（Ctrl+Alt+Shift+H）
4. **月次締めは月1回**: 同月の月次締め実行は1回のみとしてください
5. **1000件上限の監視**: 月次でTransactionsシートの行数を確認してください

---

## 管理者向け：スプレッドシート月次メンテナンス手順

### 月末作業チェックリスト

```
□ 全件 pending の申請を承認または差し戻し処理する
□ 棚卸を実施する（棚卸画面から）
□ 月次レポートを確認する
□ 月次締め（finalize）を実行する
□ StockLedger シートの opening_qty を更新する（手動）
  - 各行: opening_qty ← closing_qty の値をコピー
  - 各行: in_qty / out_qty を 0 にリセット
  - 各行: closing_qty を opening_qty と同値に更新
□ Transactions シートの行数を確認する（700行超えたら要対応）
□ スプレッドシートの変更履歴で不審な直接編集がないか確認する
```

---

*本ドキュメントは初稿です。運用を通じて随時更新してください。*
